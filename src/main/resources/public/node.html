<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Node</title>
    <script src="./common.js"></script>
    <style>
        .node {
            width: 250px;
            border: solid 2px #f0f0f0;
            margin: 5px;
            padding: 15px;
            float: left;
            border-radius: 5px;
        }

        .status-bar {
            width: 100%;
            display: flex;
            align-items: center;
            margin: 5px 0px;
        }

        .status-bar-box {
            flex-grow: 1;
            height: 8px;
            margin-left: 5px;
            border: solid 1px #d0d0d0;
        }

        .status-bar-filled {
            height: 100%;
        }

        .status-bar-lbl {
            width: 35px;
            max-width: 35px;
            overflow: hidden;
            display: block;
        }

        small {
            font-size: 0.7em;
        }
    </style>
    <script>
        function g(i) { return document.getElementById(i) }
        function getHostName(n) {
            return `<h2>${n.addr.hostname}</h2>ID: <strong>${n.addr.id}</strong>`
        }
        function getStatusBar(lbl, fill, total, color, filllbl, totallbl, lblstyle) {
            return `
                <div class="status-bar">
                    <div class='status-bar-lbl'>
                        <small style='${lblstyle}'>${lbl}</small>
                    </div>
                    <div class="status-bar-box" title="${totallbl}">
                        <div style="width: ${(fill / total) * 100}%; background: ${color};" class="status-bar-filled" title="${filllbl}"></div>
                    </div>
                </div>
            `
        }
        function diskUsage(n) {
            let x = n => (n / (1024 * 1024 * 1024)).toFixed(2);
            let disk = Object.entries(n.sysInfo.disks).map(([n, d]) => {
                let f = d.first - d.second, t = d.first;
                return getStatusBar(n, f, t, 'seagreen', `used (${x(f)}GB)`, `total (${x(t)} GB)`, 'margin-left: 10px')
            }).join('\n')
            return `
                <div style="margin: 20px 0px">
                    <small><strong>Disks</strong></small>
                    ${disk}
                    </div>
            `
        }
        function memUsage(n) {
            let x = n => (n / (1024 * 1024 * 1024)).toFixed(2), t = n.sysInfo.memorySize, f = n.sysInfo.memoryAvailable;
            return `
            <div style="margin: 20px 0px">
                ${getStatusBar('Mem', f, t, 'skyblue', `used (${x(f)}GB)`, `total (${x(t)} GB)`, 'font-weight: bold')}
                </div>
                `
        }

        function getCpuUsage(n) {
            let x = n => (n / (1024 * 1024 * 1024)).toFixed(2), t = 100, s = n.sysInfo, f = s.cpuPercent;
            return `
                <div>
                    ${getStatusBar('CPU', f, t, 'skyblue', `used (${x(f)}%s)`, ``, 'font-weight: bold')}
                </div>
            `
        }

        function getTask(t) {
            return `
                <tr style="margin: 5px">
                    <th style="padding-left: 20px">
                        ${t.taskLabel}
                        <small><a style="margin-left: 10px" target="_blank" href="http://${t.nodeDef.addr.hostname}:${t.nodeDef.addr.infoPort}/api/task/logs?taskid=${t.taskId}">logs</a></small>
                    </th>
                    <td></td>
                    <td>${getStateLbl(t.state)}</td>
                    <td>
                        ${new Date(t.stateChanges[0].second).toISOString()}
                    </td>
                    <td>
                        ${new Date(t.stateChanges[t.stateChanges.length - 1].second).toISOString()}
                    </td>
                    <td style="min-width: 100px">
                        ${getStateChange(t.stateChanges)}
                    </td>
                </tr>
            `
        }

        function getGantt(arr, colmap) {
            let out = [], tot = arr[arr.length - 1].start - arr[0].start
            for (let i = 0; i < arr.length - 1; i++) {
                let tim = (arr[i + 1].start - arr[i].start)
                out.push({ tag: arr[i].lbl, lbl: `${arr[i].lbl} (${(tim / 1000).toFixed(2)}s)`, percent: (tim * 100) / tot })
            }
            console.log(out)
            return `
                <div class="status-bar-box" style="display: flex">
                    ${out.map(o => {
                return `
                            <div style="width: ${o.percent}%; background: ${colmap[o.tag]};" class="status-bar-filled" title="${o.lbl}"></div>
                        `
            }).join('\n')}
                </div>
            `
        }

        function getStateChange(states) {
            states = states.map(s => ({ lbl: s.first, start: s.second - states[0].second }))
            if (states[states.length - 1].lbl.endsWith("ING")) {
                states.push({ lbl: 'DUMMY', start: +(new Date()) })
            }
            return getGantt(states, {
                ACCEPTED: 'skyblue',
                QUEUED: 'blue',
                RUNNING: 'orange',
                FAILED: 'red',
                SUCCEEDED: 'green'
            })
        }

        function getStateLbl(state) {
            let cols  ={
                succeeded: ['#E8F5E9', '#1B5E20'],
                failed: ['#FFEBEE', '#B71C1C'],
                running: ['#FFF3E0', '#E65100'],
                aborted: ['#FCE4EC', '#880E4F'],
                queued: ['#E3F2FD', '#0D47A1']
            }
            state = state.toLowerCase()
            console.log(state)
            return `
                <span style="background: ${cols[state][0]}; color: ${cols[state][1]}; padding: 1px 3px; border-radius: 3px">
                    ${state}
                </span>
            `
        }

        function getJob(i, job) {
            return `
                <tr>
                    <th>
                        ${i}
                    </th>
                    <td>${job.jobLabel}</td>
                    <td>${getStateLbl(job.state)}</td>
                    <td>
                        ${new Date(job.stateChanges[0].second).toISOString()}
                    </td>
                    <td>
                        ${new Date(job.stateChanges[job.stateChanges.length - 1].second).toISOString()}
                    </td>
                    <td style="min-width: 100px">
                        ${getStateChange(job.stateChanges)}
                    </td>
                </tr>
                <tr><td style="padding-left: 10px">Tasks</td></tr>
                ${Object.values(job.taskStates).map(t => getTask(t)).join('\n')}
                <tr><td style="padding: 10px"></td></tr>
            `
        }


        function getJobs(jobs) {
            return `
                <div style='margin: 40px 0px 0px 0px'>
                    <h3>Jobs: ${Object.keys(jobs).length}</h3>
                    <table style="width: 100%; text-align: left">
                        <tr>
                            <th>Job Id</th>
                            <th>Label</th>
                            <th>State</th>
                            <th>Accepted</th>
                            <th>Last update</th>
                            <th>Timeline</th>
                        </tr>
                        ${Object.entries(jobs).map(([i, job]) => getJob(i, job)).join('\n')}
                    </table>
                </div>
            `
        }
        function load(m) {
            Promise.all([get(`/api/nodes?id=${m.id}`).then(resp => resp.json), get(`/api/jobs?nodeid=${m.id}`).then(resp => resp.json)])
                .then(([node, jobs]) => {
                    let nodes = {}
                    nodes[node.addr.id] = node

                    Object.values(jobs).forEach(j => {
                        Object.values(j.taskStates).forEach(t => t.nodeDef = node)
                    })

                    g('output').innerHTML = Object.values(nodes).map(node => {
                        return `
                            ${getHostName(node)}
                            ${diskUsage(node)}
                            ${memUsage(node)}
                            ${getCpuUsage(node)}
                            ${getJobs(jobs)}
                    `
                    }).join('\n')
                })
        }
        window.onload = function () {
            const params = new URLSearchParams(window.location.search), m = {};
            params.forEach((v, k) => m[k] = v)
            load(m)
            //setInterval(() => load(), 5000);
        }
    </script>
</head>

<body>
    <div style="width: 80%; margin: auto">
        <div id="output"></div>
    </div>
</body>

</html>