<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Node</title>
    <script src="./common.js"></script>
    <link href="./styles.css" rel="stylesheet">
    <script>
        function g(i) { return document.getElementById(i) }
        function getHostName(n) {
            return `<h2>${n.addr.hostname}<small style='margin-left: 10px'><strong>(${n.addr.id}, ${n.profile.os})</strong></small></h2>`
        }

        function getTask(t) {
            return `
                <tr style="margin: 5px">
                    <th style="padding-left: 20px">
                        ${t.taskLabel}
                        <small><a style="margin-left: 10px" target="_blank" href="http://${t.nodeDef.addr.hostname}:${t.nodeDef.addr.infoPort}/api/task/logs?taskid=${t.taskId}">logs</a></small>
                    </th>
                    <td></td>
                    <td>${getStateLbl(t.state)}</td>
                    <td>
                        ${new Date(t.stateChanges[0].second).toISOString()}
                    </td>
                    <td>
                        ${new Date(t.stateChanges[t.stateChanges.length - 1].second).toISOString()}
                    </td>
                    <td style="min-width: 100px">
                        ${getStateChange(t.stateChanges)}
                    </td>
                </tr>
            `
        }

        function getGantt(arr, colmap) {
            let out = [], tot = arr[arr.length - 1].start - arr[0].start
            for (let i = 0; i < arr.length - 1; i++) {
                let tim = (arr[i + 1].start - arr[i].start)
                out.push({ tag: arr[i].lbl, lbl: `${arr[i].lbl} (${(tim / 1000).toFixed(2)}s)`, percent: (tim * 100) / tot })
            }
            console.log(out)
            return `
                <div class="status-bar-box" style="display: flex">
                    ${out.map(o => {
                return `
                            <div style="width: ${o.percent}%; background: ${colmap[o.tag]};" class="status-bar-filled" title="${o.lbl}"></div>
                        `
            }).join('\n')}
                </div>
            `
        }

        function getStateChange(states) {
            states = states.map(s => ({ lbl: s.first, start: s.second - states[0].second }))
            if (states[states.length - 1].lbl.endsWith("ING")) {
                states.push({ lbl: 'DUMMY', start: +(new Date()) })
            }
            return getGantt(states, {
                ACCEPTED: 'skyblue',
                QUEUED: 'blue',
                RUNNING: 'orange',
                FAILED: 'red',
                SUCCEEDED: 'green'
            })
        }

        function getStateLbl(state) {
            let cols = {
                succeeded: ['#E8F5E9', '#1B5E20'],
                failed: ['#FFEBEE', '#B71C1C'],
                running: ['#FFF3E0', '#E65100'],
                aborted: ['#FCE4EC', '#880E4F'],
                queued: ['#E3F2FD', '#0D47A1'],
                assigned: ['hotred', 'hotpink']
            }
            state = state.toLowerCase()
            console.log(state)
            return `
                <span style="background: ${cols[state][0]}; color: ${cols[state][1]}; padding: 1px 3px; border-radius: 3px">
                    ${state}
                </span>
            `
        }

        function getJob(job) {
            return `
                <tr>
                    <th>
                        ${job.jobId}
                    </th>
                    <td>${job.jobLabel}</td>
                    <td>${getStateLbl(job.state)}</td>
                    <td>
                        ${new Date(job.stateChanges[0].second).toISOString()}
                    </td>
                    <td>
                        ${new Date(job.stateChanges[job.stateChanges.length - 1].second).toISOString()}
                    </td>
                    <td style="min-width: 100px">
                        ${getStateChange(job.stateChanges)}
                    </td>
                </tr>
                <tr><td style="padding-left: 10px"><small><strong>Tasks</strong></small></td></tr>
                ${Object.values(job.taskStates).map(t => getTask(t)).join('\n')}
                <tr><td style="padding: 10px"></td></tr>
            `
        }

        function getJobs(jobs) {
            return `
                <div style='margin: 40px 0px 0px 0px'>
                    <h3>Jobs: ${Object.keys(jobs).length}</h3>
                    <table style="width: 100%; text-align: left">
                        <tr style='background: #e0e0e0'>
                            <th>Job Id</th>
                            <th>Label</th>
                            <th>State</th>
                            <th>Accepted</th>
                            <th>Last update</th>
                            <th>Timeline</th>
                        </tr>
                        ${Object.values(jobs).sort((b, a) => a.stateChanges[0].second - b.stateChanges[0].second).map(job => getJob(job)).join('\n')}
                    </table>
                </div>
            `
        }
        
        function load(m) {
            Promise.all([get(`/api/nodes?id=${m.id}`).then(resp => resp.json), get(`/api/jobs?nodeid=${m.id}`).then(resp => resp.json)])
                .then(([node, jobs]) => {
                    let nodes = {}
                    nodes[node.addr.id] = node

                    Object.values(jobs).forEach(j => {
                        Object.values(j.taskStates).forEach(t => t.nodeDef = node)
                    })

                    Object.values(jobs).forEach(job => {
                        let tasks = job.taskStates
                        Object.values(tasks).forEach(task => {
                            if(!task.node) return
                            if (!nodes[task.node]['taskStat']) {
                                nodes[task.node]['taskStat'] = { cnt: 0, states: {} }
                            }
                            nodes[task.node].taskStat.cnt++;
                            nodes[task.node].taskStat.states[task.state]++;
                        })
                    })

                    console.log(nodes)
                    let reducer = x => Object.values(nodes).reduce((s, t) => s + x(t), 0)
                    let totMem = reducer(n => n.profile.memorySize), usedMem = totMem - reducer(n => n.state.memoryAvailable)
                    let totCpu = 100, usedCpu = reducer(n => n.state.cpuPercent), totCores = reducer(n => n.profile.cores)
                    let totTasks = reducer(n => (n.taskStat ? n.taskStat.cnt || 0 : 0)), totBlocks = reducer(n => n.state.blocks)

                    g('output').innerHTML = Object.values(nodes).map(node => {
                        return `
                            ${getHostName(node)}
                            ${getSummary(nodes, jobs)}
                            <div style="font-size: .8em">
                            ${getJobs(jobs)}
                            </div>
                        `
                    }).join('\n')
                })
        }
        window.onload = function () {
            const params = new URLSearchParams(window.location.search), m = {};
            params.forEach((v, k) => m[k] = v)
            load(m)
            setInterval(() => load(m), 5000);
        }
    </script>
</head>

<body>
    <div style="width: 80%; margin: auto">
        <div class="header">
            <strong style="flex-grow: 1;">sdfs-monitor</strong>
            <div style="display: flex">
                <a href="/">nodes</a>
                <a href="/jobs.html">jobs</a>
            </div>
        </div>
        <div id="output" style="padding: 0px 20px"></div>
    </div>
</body>

</html>